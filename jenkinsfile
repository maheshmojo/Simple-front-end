pipeline {
    agent none

    stages {
        stage("build and test the project") {
            agent {
                label 'Master-Production'
            }
            tools {
                nodejs "nodejs"
            }
            stages {
               stage("Checkout SCM For Master-Production") {
                   steps {
                      git branch: 'Master-main', url: 'https://github.com/maheshmojo/Simple-front-end.git'
                      
                   }
               }
               stage("Build") {
                   steps {
                        // sh 'npm install'
                        // sh 'npm run build'
                        // sh 'npm install --save-dev sonar-scanner'
                        // sh 'npm run sonar'
                        sh 'docker build -t simple-front-end-app:${BUILD_ID} .'
                   }
               }
               stage("Build to Docker Registry") {
                   steps {
                        sh 'sudo docker tag simple-front-end-app:${BUILD_ID} 192.168.33.10:8123/front-end-app:MASTER${BUILD_ID}'
                        sh 'sudo docker push 192.168.33.10:8123/front-end-app:MASTER${BUILD_ID}'
                      
                   }
               }
               stage("Run the container") {
                   steps {
                      sh 'sudo docker container rm -f simple-front-end-app'
                      sh 'sudo docker container run -p 4200:80 --name simple-front-end-app -d simple-front-end-app:${BUILD_ID}'
                   }
                }
            }
        }

        stage("DEVELOPMENT_SERVER") {
            agent {
                label 'DEVELOPMENT_SERVER'
            }
            tools {
                 nodejs "nodejs"
            }
            steps {
                // Get the code from a GitHub repository
                     git branch: 'DEV', url: 'https://github.com/maheshmojo/Simple-front-end.git'
                    //  sh 'npm install'
                    //  sh 'npm run build'
                    //  sh 'npm install --save-dev sonar-scanner'
                    //  sh 'npm run sonar'
                     sh 'docker build -t simple-front-end-app:${BUILD_ID} .'
                     sh 'sudo docker tag simple-front-end-app:${BUILD_ID} 192.168.33.10:8123/front-end-app:DEV${BUILD_ID}'
                     sh 'sudo docker push 192.168.33.10:8123/front-end-app:DEV${BUILD_ID}'
                     sh 'sudo docker container rm -f simple-front-end-app'
                     sh 'sudo docker container run -p 4200:80 --name simple-front-end-app -d simple-front-end-app:${BUILD_ID}'
            }
        }
    }
}
